#cloud-config
autoinstall:
  version: 1
  refresh-installer:
    update: yes
  interactive-sections:
    - storage
  identity:
    hostname: secure-host
    username: secure-user
    password: "$6$kTS2D0QZCV6HXAjb$HZNC6xHQVtckeq/zkvv0xKCoxMdjlH8pUq48Zn0/fSlxa/O2v0/.5CZKCJOn9iBmckVekRt/JDOCrWfTjRtXQ/"
  locale: en_GB.UTF-8
  timezone: Europe/London
  keyboard:
    layout: us
  storage:
    layout:
      name: custom
    config:
      - id: part0
        type: partition
        size: 512M
        flag: boot
      - id: part1
        type: partition
        size: -1
      - id: vg0
        type: lvm_volgroup
        devices:
          - part1
        name: vg0
      - id: lvroot
        type: lvm_partition
        volgroup: vg0
        size: 50%
        name: root
      - id: lvhome
        type: lvm_partition
        volgroup: vg0
        size: 50%
        name: home
      - id: format-boot
        type: format
        fstype: fat32
        volume: part0
        preserve: false
      - id: format-root
        type: format
        fstype: ext4
        volume: lvroot
        preserve: false
      - id: format-home
        type: format
        fstype: ext4
        volume: lvhome
        preserve: false
      - id: mount-boot
        type: mount
        path: /boot
        device: part0
        format: format-boot
      - id: mount-root
        type: mount
        path: /
        device: lvroot
        format: format-root
      - id: mount-home
        type: mount
        path: /home
        device: lvhome
        format: format-home
  network:
    version: 2
    ethernets:
      id0:
        match:
          name: "en*"
        dhcp4: true
      id1:
        match:
          name: "eth*"
        dhcp4: true
  packages:
    - build-essential
    - network-manager
    - dkms
    - emacs-nox
    - ubuntu-desktop-minimal
    - apparmor
    - apparmor-utils
    - vim
    - gnupg
    - firefox
    - gnome-shell
    - gnome-software
    - gnome-tweaks
    - torbrowser-launcher
    - keepassxc
    - fail2ban
    - secure-delete
    - wipe
    - gufw
    - rkhunter
    - clamav
    - clamav-daemon
    - kleopatra
  package_update: true
  package_upgrade: true
  snaps: []
  late-commands:
    - curtin in-target --target=/target -- sed -i 's/ds=nocloud-net[^"]*//' /etc/default/grub
    - curtin in-target --target=/target -- sed -i 's/autoinstall//' /etc/default/grub
    - curtin in-target --target=/target -- sed -i 's/GRUB_TIMEOUT=0/GRUB_TIMEOUT=5/' /etc/default/grub
    - curtin in-target --target=/target -- sed -i 's/GRUB_TIMEOUT_STYLE=hidden/GRUB_TIMEOUT_STYLE=menu/' /etc/default/grub
    - curtin in-target --target=/target -- sed -i 's/quiet autoinstall/quiet splash/' /etc/default/grub
    - curtin in-target --target=/target -- /bin/bash -c 'source /etc/default/grub && update-grub'
    - curtin in-target --target=/target -- systemctl disable sssd
    - curtin in-target --target=/target -- touch /etc/cloud/cloud-init.disabled
    - curtin in-target --target=/target -- rm -rf /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg
    - curtin in-target --target=/target -- rm -rf /var/lib/cloud/instance
    - curtin in-target --target=/target -- dpkg-reconfigure cloud-init
    - curtin in-target --target=/target -- sh -c 'echo "datasource_list: [ None ]" > /etc/cloud/cloud.cfg.d/90_dpkg.cfg'
  runcmd:
    - echo '#!/bin/bash' > /root/first-boot.sh
    - echo 'set -e' >> /root/first-boot.sh
    - echo 'exec > /root/first-boot.log 2>&1' >> /root/first-boot.sh
    - echo 'echo "Starting first-boot.sh"' >> /root/first-boot.sh
    - echo 'echo "Running initial local configuration"' >> /root/first-boot.sh
    - echo 'systemctl enable fail2ban || true' >> /root/first-boot.sh
    - echo 'systemctl restart fail2ban || true' >> /root/first-boot.sh
    - echo 'aa-enforce /etc/apparmor.d/* || true' >> /root/first-boot.sh
    - echo 'sed -i "/defaults/ s/defaults/defaults,noatime,nodiratime,commit=120/" /etc/fstab' >> /root/first-boot.sh
    - echo '#!/bin/bash' > /root/after-network.sh
    - echo 'set -e' >> /root/after-network.sh
    - echo 'exec > /root/after-network.log 2>&1' >> /root/after-network.sh
    - echo 'echo "Starting after-network.sh"' >> /root/after-network.sh
    - echo 'apt-get update' >> /root/after-network.sh
    - echo 'apt-get dist-upgrade --yes' >> /root/after-network.sh
    - echo 'apt autoremove --yes' >> /root/after-network.sh
    - echo 'apt-get install --yes nvidia-driver-570' >> /root/after-network.sh
    - echo 'sudo -u ubuntu dbus-launch gsettings set org.gnome.desktop.background picture-uri https://images5.alphacoders.com/652/652555.png' >> /root/after-network.sh
    - echo 'apt-get install -y software-properties-common' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:graphics-drivers/ppa || true' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:libreoffice/ppa || true' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:mozillateam/ppa || true' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:chromium-team/stable || true' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:git-core/ppa || true' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:chris-lea/node.js || true' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:videolan/master-daily || true' >> /root/after-network.sh
    - echo 'add-apt-repository -y ppa:jonathonf/ffmpeg-4 || true' >> /root/after-network.sh
    - echo 'apt-get update' >> /root/after-network.sh
    - echo 'apt-get install -y curl unzip fail2ban rkhunter gufw linux-headers-$(uname -r) secure-delete wipe gnupg clamav clamav-daemon gnome-tweaks dconf-cli' >> /root/after-network.sh
    - echo 'apt-get remove -y mdadm || true' >> /root/after-network.sh
    - echo 'wget -q -O - https://repo.protonvpn.com/debian/public_key.asc | apt-key add -' >> /root/after-network.sh
    - echo 'echo "deb https://repo.protonvpn.com/debian stable main" > /etc/apt/sources.list.d/protonvpn.list' >> /root/after-network.sh
    - echo 'apt-get update' >> /root/after-network.sh
    - echo 'apt-get install -y protonvpn' >> /root/after-network.sh
    - echo 'freshclam' >> /root/after-network.sh
    - echo 'clamscan -r --bell -i / || true' >> /root/after-network.sh
    - echo 'gufw default deny incoming || true' >> /root/after-network.sh
    - echo 'gufw default allow outgoing || true' >> /root/after-network.sh
    - echo 'gufw allow from any to any port 1194 proto udp || true' >> /root/after-network.sh
    - echo 'gufw allow 22/tcp || true' >> /root/after-network.sh
    - echo 'gufw enable || true' >> /root/after-network.sh
    - echo 'wget -O /tmp/obsidian.deb https://github.com/obsidianmd/obsidian-releases/releases/download/v1.6.3/obsidian_1.6.3_amd64.deb' >> /root/after-network.sh
    - echo 'dpkg -i /tmp/obsidian.deb || apt-get -f install -y' >> /root/after-network.sh
    - echo 'wget -O- https://updates.signal.org/desktop/apt/keys.asc | apt-key add -' >> /root/after-network.sh
    - echo 'echo "deb [arch=amd64] https://updates.signal.org/desktop/apt xenial main" > /etc/apt/sources.list.d/signal-xenial.list' >> /root/after-network.sh
    - echo 'apt-get update' >> /root/after-network.sh
    - echo 'apt-get install -y signal-desktop' >> /root/after-network.sh
    - echo 'echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf' >> /root/after-network.sh
    - echo 'echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /root/after-network.sh
    - echo 'echo "net.ipv6.conf.lo.disable_ipv6 = 1" >> /root/after-network.sh
    - echo 'echo "net.ipv4.conf.all.rp_filter=1" >> /root/after-network.sh
    - echo 'echo "net.ipv4.conf.default.rp_filter=1" >> /root/after-network.sh
    - echo 'echo "net.ipv4.tcp_syncookies=1" >> /root/after-network.sh
    - echo 'echo "net.ipv4.conf.all.accept_redirects=0" >> /root/after-network.sh
    - echo 'echo "net.ipv6.conf.all.accept_redirects=0" >> /root/after-network.sh
    - echo 'echo "net.ipv4.conf.all.secure_redirects=0" >> /root/after-network.sh
    - echo 'echo "net.ipv4.icmp_echo_ignore_broadcasts=1" >> /root/after-network.sh
    - echo 'echo "net.ipv4.icmp_ignore_bogus_error_responses=1" >> /root/after-network.sh
    - echo 'echo "kernel.randomize_va_space=2" >> /root/after-network.sh
    - echo 'echo "vm.swappiness=10" >> /root/after-network.sh
    - echo 'echo "vm.dirty_ratio=20" >> /root/after-network.sh
    - echo 'echo "vm.dirty_background_ratio=5" >> /root/after-network.sh
    - echo 'sysctl -p || true' >> /root/after-network.sh
    - echo 'wget -q https://downloads.nordcdn.com/configs/archives/servers/ovpn.zip -O /etc/openvpn/nordvpn.zip' >> /root/after-network.sh
    - echo 'wget -q https://mullvad.net/download/openvpn-config/ -O /etc/openvpn/mullvad.zip' >> /root/after-network.sh
    - echo 'wget -q https://protonvpn.com/download/protonvpn.zip -O /etc/openvpn/protonvpn.zip' >> /root/after-network.sh
    - echo 'unzip /etc/openvpn/nordvpn.zip -d /etc/openvpn/nordvpn' >> /root/after-network.sh
    - echo 'unzip /etc/openvpn/mullvad.zip -d /etc/openvpn/mullvad' >> /root/after-network.sh
    - echo 'unzip /etc/openvpn/protonvpn.zip -d /etc/openvpn/protonvpn' >> /root/after-network.sh
    - echo 'for vpn_file in /etc/openvpn/nordvpn/*.ovpn; do nmcli con add type vpn ifname -- vpn-type openvpn con-name "nordvpn-$(basename ${vpn_file})" -- connection.interface-name "" vpn.data "connection-type=password,service-type=openvpn,username=nordvpn_username,password-flags=0" vpn.secrets "password=nordvpn_password" vpn.file "${vpn_file}"; done || true' >> /root/after-network.sh
    - echo 'for vpn_file in /etc/openvpn/mullvad/*.ovpn; do nmcli con add type vpn ifname -- vpn-type openvpn con-name "mullvad-$(basename ${vpn_file})" -- connection.interface-name "" vpn.data "connection-type=password,service-type=openvpn,username=mullvad_username,password-flags=0" vpn.secrets "password=mullvad_password" vpn.file "${vpn_file}"; done || true' >> /root/after-network.sh
    - echo 'for vpn_file in /etc/openvpn/protonvpn/*.ovpn; do nmcli con add type vpn ifname -- vpn-type openvpn con-name "protonvpn-$(basename ${vpn_file})" -- connection.interface-name "" vpn.data "connection-type=password,service-type=openvpn,username=protonvpn_username,password-flags=0" vpn.secrets "password=protonvpn_password" vpn.file "${vpn_file}"; done || true' >> /root/after-network.sh
    - echo '#!/bin/bash' > /etc/network/if-pre-up.d/random-vpn
    - echo 'VPN_FILES=(/etc/openvpn/nordvpn/*.ovpn /etc/openvpn/mullvad/*.ovpn /etc/openvpn/protonvpn/*.ovpn)' >> /etc/network/if-pre-up.d/random-vpn
    - echo 'RANDOM_VPN_FILE=${VPN_FILES[$RANDOM % ${#VPN_FILES[@]}]}' >> /etc/network/if-pre-up.d/random-vpn
    - echo 'nmcli con up "${RANDOM_VPN_FILE}"' >> /etc/network/if-pre-up.d/random-vpn
    - chmod +x /etc/network/if-pre-up.d/random-vpn
    - echo 'rm /etc/systemd/system/first-boot.service' >> /root/after-network.sh
    - echo 'rm /etc/systemd/system/after-network.service' >> /root/after-network.sh
    - echo 'rm /root/first-boot.sh' >> /root/after-network.sh
    - echo 'rm /root/after-network.sh' >> /root/after-network.sh
    - |
      cat <<EOF | sudo tee /etc/systemd/system/first-boot.service
      [Unit]
      Description=Run first boot script
      After=network-online.target
      Wants=network-online.target

      [Service]
      ExecStart=/root/first-boot.sh
      Type=oneshot
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target
      EOF
    - |
      cat <<EOF | sudo tee /etc/systemd/system/after-network.service
      [Unit]
      Description=Run after-network script
      After=network-online.target
      Wants=network-online.target

      [Service]
      ExecStart=/root/after-network.sh
      Type=oneshot
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target
      EOF
    - systemctl enable first-boot.service
    - systemctl enable after-network.service
    - chmod +x /root/first-boot.sh
    - chmod +x /root/after-network.sh

