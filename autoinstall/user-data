#cloud-config
autoinstall:
  version: 1
  refresh-installer:
    update: yes
  interactive-sections:
    - storage
  identity:
    hostname: secure-host
    username: secure-user
    password: "$6$kTS2D0QZCV6HXAjb$HZNC6xHQVtckeq/zkvv0xKCoxMdjlH8pUq48Zn0/fSlxa/O2v0/.5CZKCJOn9iBmckVekRt/JDOCrWfTjRtXQ/"
  locale: en_GB.UTF-8
  timezone: Europe/London
  keyboard:
    layout: us
  storage:
    layout:
      name: direct
  network:
    version: 2
    ethernets:
      id0:
        match:
          name: "en*"
        dhcp4: true
      id1:
        match:
          name: "eth*"
        dhcp4: true
  packages:
    - build-essential
    - network-manager
    - dkms
    - emacs-nox
    - ubuntu-desktop-minimal
    - apparmor
    - apparmor-utils
    - vim
    - gnupg
    - firefox
    - gnome-shell
    - gnome-software
    - gnome-tweaks
    - torbrowser-launcher
    - keepassxc
    - fail2ban
    - secure-delete
    - wipe
    - gufw
    - rkhunter
    - clamav
    - clamav-daemon
    - kleopatra
  snaps: []
  late-commands:
    # Changing from networkd to NetworkManager
    # move existing config out of the way
    - "find /target/etc/netplan/ -name '*.yaml' -exec sh -c 'mv \"$1\" \"$1-orig\"' _ {} \\; || true"
    # Create a new netplan and enable it
    - |
      cat <<EOF | sudo tee /target/etc/netplan/01-netcfg.yaml
      network:
        version: 2
        ethernets:
          id0:
            match:
              name: "en*"
            dhcp4: true
          id1:
            match:
              name: "eth*"
            dhcp4: true
        renderer: NetworkManager
      EOF
    - "curtin in-target --target /target netplan generate || true"
    - "curtin in-target --target /target netplan apply || true"
    - "curtin in-target --target /target systemctl enable NetworkManager.service || true"
    - "wget -O /target/tmp/obsidian.deb https://github.com/obsidianmd/obsidian-releases/releases/download/v1.6.3/obsidian_1.6.3_amd64.deb || echo 'Failed to download Obsidian' >> /target/var/log/late-command-errors.log || true"
    - "curtin in-target --target=/target -- sh -c 'dpkg -i /tmp/obsidian.deb || apt-get -f install -y' || echo 'Failed to install Obsidian' >> /target/var/log/late-command-errors.log || true"
    - "wget -O /target/tmp/notesnook.AppImage https://notesnook.com/releases/linux/notesnook_linux_x86_64.AppImage || echo 'Failed to download Notesnook' >> /target/var/log/late-command-errors.log || true"
    - "chmod +x /target/tmp/notesnook.AppImage || echo 'Failed to make Notesnook executable' >> /target/var/log/late-command-errors.log || true"
    - "mv /target/tmp/notesnook.AppImage /target/usr/local/bin/notesnook || echo 'Failed to move Notesnook' >> /target/var/log/late-command-errors.log || true"
    - "curtin in-target --target=/target -- sh -c 'apt-get update && apt-get install -y gnupg || true'"
    - "wget -O- https://updates.signal.org/desktop/apt/keys.asc | curtin in-target --target=/target -- gpg --dearmor -o /usr/share/keyrings/signal-desktop-keyring.gpg || true"
    - "sh -c 'echo \"deb [signed-by=/usr/share/keyrings/signal-desktop-keyring.gpg] https://updates.signal.org/desktop/apt xenial main\" > /target/etc/apt/sources.list.d/signal-xenial.list' || echo 'Failed to add Signal repo' >> /target/var/log/late-command-errors.log || true"
    - "curtin in-target --target=/target -- sh -c 'apt-get update && apt-get install -y signal-desktop' || echo 'Failed to install Signal' >> /target/var/log/late-command-errors.log || true"
  user-data:
    runcmd:
      - apt-get update
      - apt-get dist-upgrade --yes
      - apt-get install -y software-properties-common
      - add-apt-repository -y ppa:graphics-drivers/ppa || true
      - add-apt-repository -y ppa:libreoffice/ppa || true
      - add-apt-repository -y ppa:mozillateam/ppa || true
      - add-apt-repository -y ppa:chromium-team/stable || true
      - add-apt-repository -y ppa:git-core/ppa || true
      - add-apt-repository -y ppa:chris-lea/node.js || true
      - add-apt-repository -y ppa:videolan/master-daily || true
      - add-apt-repository -y ppa:jonathonf/ffmpeg-4 || true
      - apt-get update
      - apt-get install -y curl unzip fail2ban rkhunter gufw linux-headers-$(uname -r) secure-delete wipe gnupg clamav clamav-daemon gnome-tweaks dconf-cli
      - |
        cat << EOF > /etc/fail2ban/jail.local
        [DEFAULT]
        bantime = 1h
        findtime = 10m
        maxretry = 5
        backend = auto
        destemail = root@localhost
        sendername = Fail2Ban
        mta = sendmail
        action = %(action_mwl)s

        [sshd]
        enabled = true
        port = ssh
        filter = sshd
        logpath = /var/log/auth.log
        maxretry = 3

        [sshd-ddos]
        enabled = true
        port = ssh
        filter = sshd-ddos
        logpath = /var/log/auth.log
        maxretry = 2

        [recidive]
        enabled = true
        logpath = /var/log/fail2ban.log
        bantime = 1d
        findtime = 1d
        maxretry = 5
        action = iptables-multiport[name=recidive, port="ssh,smtp,imap2,imap3,pop3,pop3s", protocol=tcp]
        EOF
      - systemctl enable fail2ban || true
      - systemctl restart fail2ban || true
      - rkhunter --update || true
      - rkhunter --propupd || true
      - rkhunter --check --skip-keypress || true
      - gufw default deny incoming || true
      - gufw default allow outgoing || true
      - gufw allow from any to any port 1194 proto udp || true
      - gufw allow 22/tcp || true
      - gufw enable || true
      - fallocate -l 4G /swapfile || true
      - chmod 600 /swapfile || true
      - echo YES | cryptsetup luksFormat /swapfile || true
      - cryptsetup open /swapfile cryptswap || true
      - mkswap /dev/mapper/cryptswap || true
      - swapon /dev/mapper/cryptswap || true
      - echo '/dev/mapper/cryptswap none swap sw 0 0' >> /etc/fstab || true
      - echo 'kernel.kptr_restrict=2' >> /etc/sysctl.conf || true
      - echo 'kernel.perf_event_paranoid=3' >> /etc/sysctl.conf || true
      - echo 'kernel.yama.ptrace_scope=1' >> /etc/sysctl.conf || true
      - echo 'net.core.bpf_jit_harden=2' >> /etc/sysctl.conf || true
      - echo 'net.ipv4.conf.all.accept_source_route=0' >> /etc/sysctl.conf || true
      - echo 'net.ipv4.conf.default.accept_source_route=0' >> /etc/sysctl.conf || true
      - echo 'net.ipv4.conf.all.log_martians=1' >> /etc/sysctl.conf || true
      - echo 'net.ipv4.conf.default.log_martians=1' >> /etc/sysctl.conf || true
      - sysctl -p || true
      - freshclam || true
      - systemctl enable clamav-daemon || true
      - systemctl start clamav-daemon || true
      - gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark' || true
      - gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark' || true
      - systemctl disable bluetooth || true
      - systemctl stop bluetooth || true
      - sysctl -p || true
      - gsettings set org.gnome.shell favorite-apps "['org.gnome.Nautilus.desktop', 'firefox.desktop', 'org.gnome.Terminal.desktop', 'keepassxc_keepassxc.desktop', 'torbrowser-launcher.desktop', 'org.gnome.tweaks.desktop', 'org.gnome.Software.desktop', 'kleopatra.desktop']" || true
      - reboot || true

