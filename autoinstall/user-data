#cloud-config
autoinstall:
  version: 1
  refresh-installer:  # start with an up-to-date installer
  update: yes
  interactive-sections:  # Install groups listed here will wait for user input
    - storage
  storage:  # should set the interactive default but doesn't seem to work??
    layout:
      name: direct
  network:
    version: 2
    ethernets:
      id0:
        match:
          name: "en*"
        dhcp4: true
      id1:
        match:
          name: "eth*"
        dhcp4: true
  locale: en_GB.UTF-8
  timezone: Europe/London
  keyboard:
    layout: us
  identity:
    hostname: secure-host
    username: secure-user
    password: "$6$kTS2D0QZCV6HXAjb$HZNC6xHQVtckeq/zkvv0xKCoxMdjlH8pUq48Zn0/fSlxa/O2v0/.5CZKCJOn9iBmckVekRt/JDOCrWfTjRtXQ/"
  packages:
    - build-essential
    - network-manager
    - dkms
    - emacs-nox
    - ubuntu-desktop-minimal
    - apparmor
    - apparmor-utils
    - vim
    - gnupg
    - firefox
    - gnome-shell
    - gnome-software
    - gnome-tweaks
    - torbrowser-launcher
    - keepassxc
    - fail2ban
    - secure-delete
    - wipe
    - ufw
    - openvpn
  snaps: []
  late-commands:
    # Changing from networkd to NetworkManager
    # move existing config out of the way
    - find /target/etc/netplan/ -name "*.yaml" -exec sh -c 'mv "$1" "$1-orig"' _ {} \;
    # Create a new netplan and enable it
    - |
      cat <<EOF | sudo tee /target/etc/netplan/01-netcfg.yaml
      network:
        version: 2
        ethernets:
          eth0:
            dhcp4: true
        renderer: NetworkManager
      EOF
    - curtin in-target --target /target netplan generate
    - curtin in-target --target /target netplan apply
    - curtin in-target --target /target systemctl enable NetworkManager.service
    - curtin in-target --target=/target apt-get install -y apparmor-profiles
    - wget -O- https://updates.signal.org/desktop/apt/keys.asc | curtin in-target --target=/target apt-key add -
    - echo 'deb [arch=amd64] https://updates.signal.org/desktop/apt xenial main' | tee -a /target/etc/apt/sources.list.d/signal-xenial.list
    - curtin in-target --target=/target apt-get update
    - curtin in-target --target=/target apt-get install -y signal-desktop
    - wget -O /target/tmp/notesnook.deb https://download.notesnook.com/linux/notesnook-latest-amd64.deb
    - curtin in-target --target=/target dpkg -i /tmp/notesnook.deb
    - curtin in-target --target=/target apt-get -f install -y
    # Download post_install.sh from GitHub, make it executable and run it
    - wget -O /target/root/post_install.sh https://raw.githubusercontent.com/yourusername/yourrepository/main/post_install.sh
    - curtin in-target --target=/target chmod +x /root/post_install.sh
    - curtin in-target --target=/target /root/post_install.sh
  user-data: # Commands here run during first boot (cannot be interactive)
    runcmd:
      # Install the NVIDIA driver from the ppa we setup earlier
      - [apt-get, update]
      - [apt-get, dist-upgrade, --yes]
      - [apt, autoremove, --yes]
      - [apt-get, install, --yes,  nvidia-driver-570] #, --no-install-recommends]
      - [sudo, -u, ubuntu, dbus-launch, gsettings, set, org.gnome.desktop.background, picture-uri, file:///usr/share/backgrounds/Puget_Systems.png]

