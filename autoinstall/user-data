#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: secure-host
    username: secure-user
    password: "$6$kTS2D0QZCV6HXAjb$HZNC6xHQVtckeq/zkvv0xKCoxMdjlH8pUq48Zn0/fSlxa/O2v0/.5CZKCJOn9iBmckVekRt/JDOCrWfTjRtXQ/"
  interactive-sections:
    - storage
  locale: en_GB.UTF-8
  timezone: Europe/London
  network:
    version: 2
    ethernets:
      enp6s0:
        dhcp4: true
  apt:
    preserve_sources_list: false
    primary:
      - arches: [default]
        uri: http://archive.ubuntu.com/ubuntu/
    security:
      - arches: [default]
        uri: http://security.ubuntu.com/ubuntu/
    extra:
      - arches: [default]
        uri: http://archive.ubuntu.com/ubuntu/
        suite: universe
      - arches: [default]
        uri: http://archive.ubuntu.com/ubuntu/
        suite: multiverse
  packages:
    - snapd
    - apparmor
    - apparmor-profiles
    - apparmor-utils
    - cryptsetup
    - vim
    - curl
    - secure-delete
    - wipe
    - gnupg
    - openvpn
    - unattended-upgrades
    - gnome-tweaks
  snaps:
    - name: notesnook
    - name: torbrowser-launcher
    - name: veracrypt
    - name: keepassxc
    - name: signal-desktop
    - name: brave
    - name: gufw
  early-commands:
    - "echo 'Adding necessary repositories'"
    - "chroot /target apt-add-repository -y ppa:unit193/encryption"
    - "chroot /target apt-add-repository -y ppa:ubuntu-desktop/ppa"
    - "chroot /target apt-get update"
  late-commands:
    - "chroot /target apt-get update"
    - "chroot /target apt-get install -y ubuntu-desktop || echo 'ubuntu-desktop not found' >> /target/root/install_errors.log || true"
    - "chroot /target apt-get install -y fail2ban || echo 'fail2ban not found' >> /target/root/install_errors.log || true"
    - "echo 'net.ipv6.conf.all.disable_ipv6 = 1' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv6.conf.default.disable_ipv6 = 1' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv6.conf.lo.disable_ipv6 = 1' >> /target/etc/sysctl.conf"
    - "chroot /target gufw default deny incoming || true"
    - "chroot /target gufw default allow outgoing || true"
    - "chroot /target gufw allow from any to any port 1194 proto udp || true"
    - "chroot /target gufw allow 22/tcp || true"
    - "chroot /target gufw enable || true"
    - "chroot /target fallocate -l 4G /swapfile"
    - "chroot /target chmod 600 /swapfile"
    - "echo YES | chroot /target cryptsetup luksFormat /swapfile"
    - "chroot /target cryptsetup open /swapfile cryptswap"
    - "chroot /target mkswap /dev/mapper/cryptswap"
    - "chroot /target swapon /dev/mapper/cryptswap"
    - "echo '/dev/mapper/cryptswap none swap sw 0 0' >> /target/etc/fstab"
    - "echo '[DEFAULT]' > /target/etc/fail2ban/jail.local"
    - "echo 'bantime  = 10m' >> /target/etc/fail2ban/jail.local"
    - "echo 'findtime  = 10m' >> /target/etc/fail2ban/jail.local"
    - "echo 'maxretry = 5' >> /target/etc/fail2ban/jail.local"
    - "echo '[sshd]' >> /target/etc/fail2ban/jail.local"
    - "echo 'enabled = true' >> /target/etc/fail2ban/jail.local"
    - "echo 'port = ssh' >> /target/etc/fail2ban/jail.local"
    - "echo 'filter = sshd' >> /target/etc/fail2ban/jail.local"
    - "echo 'logpath = /var/log/auth.log' >> /target/etc/fail2ban/jail.local"
    - "echo 'maxretry = 3' >> /target/etc/fail2ban/jail.local"
    - "echo '[sshd-ddos]' >> /target/etc/fail2ban/jail.local"
    - "echo 'enabled = true' >> /target/etc/fail2ban/jail.local"
    - "echo 'port = ssh' >> /target/etc/fail2ban/jail.local"
    - "echo 'filter = sshd-ddos' >> /target/etc/fail2ban/jail.local"
    - "echo 'logpath = /var/log/auth.log' >> /target/etc/fail2ban/jail.local"
    - "echo 'maxretry = 2' >> /target/etc/fail2ban/jail.local"
    - "echo '[recidive]' >> /target/etc/fail2ban/jail.local"
    - "echo 'enabled = true' >> /target/etc/fail2ban/jail.local"
    - "echo 'logpath  = /var/log/fail2ban.log' >> /target/etc/fail2ban/jail.local"
    - "echo 'bantime  = 1d' >> /target/etc/fail2ban/jail.local"
    - "echo 'findtime  = 1d' >> /target/etc/fail2ban/jail.local"
    - "echo 'maxretry = 5' >> /target/etc/fail2ban/jail.local"
    - "echo 'action = iptables-multiport[name=recidive, port=\"ssh,smtp,imap2,imap3,pop3,pop3s\", protocol=tcp]' >> /target/etc/fail2ban/jail.local"
    - "chroot /target systemctl restart fail2ban || true"
    - "echo 'Unattended-Upgrade::Allowed-Origins {\n\t\"${distro_id}:${distro_codename}-security\";\n};' > /target/etc/apt/apt.conf.d/50unattended-upgrades"
    - "echo 'APT::Periodic::Update-Package-Lists \"1\";' > /target/etc/apt/apt.conf.d/20auto-upgrades"
    - "echo 'APT::Periodic::Unattended-Upgrade \"1\";' >> /target/etc/apt/apt.conf.d/20auto-upgrades"
    - "echo 'APT::Periodic::AutocleanInterval \"7\";' >> /target/etc/apt/apt.conf.d/20auto-upgrades"
    - "echo 'APT::Periodic::Download-Upgradeable-Packages \"1\";' >> /target/etc/apt/apt.conf.d/20auto-upgrades"
    - "wget -q https://downloads.nordcdn.com/configs/archives/servers/ovpn.zip -O /target/etc/openvpn/nordvpn.zip"
    - "wget -q https://mullvad.net/download/openvpn-config/ -O /target/etc/openvpn/mullvad.zip"
    - "wget -q https://protonvpn.com/download/protonvpn.zip -O /target/etc/openvpn/protonvpn.zip"
    - "unzip /target/etc/openvpn/nordvpn.zip -d /target/etc/openvpn/nordvpn"
    - "unzip /target/etc/openvpn/mullvad.zip -d /target/etc/openvpn/mullvad"
    - "unzip /target/etc/openvpn/protonvpn.zip -d /target/etc/openvpn/protonvpn"
    - |
      for vpn_file in /target/etc/openvpn/nordvpn/*.ovpn; do
        chroot /target nmcli con add type vpn ifname -- vpn-type openvpn con-name "nordvpn-$(basename ${vpn_file})" -- connection.interface-name '' vpn.data 'connection-type=password,service-type=openvpn,username=nordvpn_username,password-flags=0' vpn.secrets 'password=nordvpn_password' vpn.file "${vpn_file}";
      done || true
    - |
      for vpn_file in /target/etc/openvpn/mullvad/*.ovpn; do
        chroot /target nmcli con add type vpn ifname -- vpn-type openvpn con-name "mullvad-$(basename ${vpn_file})" -- connection.interface-name '' vpn.data 'connection-type=password,service-type=openvpn,username=mullvad_username,password-flags=0' vpn.secrets 'password=mullvad_password' vpn.file "${vpn_file}";
      done || true
    - |
      for vpn_file in /target/etc/openvpn/protonvpn/*.ovpn; do
        chroot /target nmcli con add type vpn ifname -- vpn-type openvpn con-name "protonvpn-$(basename ${vpn_file})" -- connection.interface-name '' vpn.data 'connection-type=password,service-type=openvpn,username=protonvpn_username,password-flags=0' vpn.secrets 'password=protonvpn_password' vpn.file "${vpn_file}";
      done || true
    - "echo '#!/bin/bash' > /target/etc/network/if-pre-up.d/random-vpn"
    - "echo 'VPN_FILES=(/etc/openvpn/nordvpn/*.ovpn /etc/openvpn/mullvad/*.ovpn /etc/openvpn/protonvpn/*.ovpn)' >> /target/etc/network/if-pre-up.d/random-vpn"
    - "echo 'RANDOM_VPN_FILE=${VPN_FILES[$RANDOM % ${#VPN_FILES[@]}]}' >> /target/etc/network/if-pre-up.d/random-vpn"
    - "echo 'nmcli con up \"${RANDOM_VPN_FILE}\"' >> /target/etc/network/if-pre-up.d/random-vpn"
    - "chmod +x /target/etc/network/if-pre-up.d/random-vpn"
    - "echo 'net.ipv4.conf.all.rp_filter=1' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv4.conf.default.rp_filter=1' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv4.tcp_syncookies=1' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv4.conf.all.accept_redirects=0' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv6.conf.all.accept_redirects=0' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv4.conf.all.secure_redirects=0' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv4.icmp_echo_ignore_broadcasts=1' >> /target/etc/sysctl.conf"
    - "echo 'net.ipv4.icmp_ignore_bogus_error_responses=1' >> /target/etc/sysctl.conf"
    - "echo 'kernel.randomize_va_space=2' >> /target/etc/sysctl.conf"
    - "chroot /target aa-enforce /etc/apparmor.d/* || true"
    - "sed -i '/defaults/ s/defaults/defaults,noatime,nodiratime,commit=120/' /target/etc/fstab"
    - "echo 'vm.swappiness=10' >> /target/etc/sysctl.conf"
    - "echo 'vm.dirty_ratio=20' >> /target/etc/sysctl.conf"
    - "echo 'vm.dirty_background_ratio=5' >> /target/etc/sysctl.conf"
    - "wget -O- https://updates.signal.org/desktop/apt/keys.asc | chroot /target apt-key add -"
    - "echo 'deb [arch=amd64] https://updates.signal.org/desktop/apt xenial main' | tee -a /target/etc/apt/sources.list.d/signal-xenial.list"
    - "chroot /target apt-get update"
    - "chroot /target apt-get upgrade -y || true"
    - "chroot /target shutdown -h now"

